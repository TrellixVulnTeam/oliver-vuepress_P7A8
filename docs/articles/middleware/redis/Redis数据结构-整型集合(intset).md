---
isTimeLine: true
sidebar: true
isComment: false
title: Redis数据结构-整型集合(intset)
date: 2022-4-20
tags:
- Redis
---

> 整型集合 `(intset)`  是集合的底层实现之一，当一个集合 只包含 `整型元素` 且 `元素数量并不多`时，Redis就会使用 整型集合 

## 基本数据结构

> 整型集合 `(intset)`  可以保存类型为int16_t、int32_t或者int64_t的整数值
>
> 并且保证集合中`不会出现重复元素`

```C
struct intset {     
  uint32_t encoding; // 编码方式 
  uint32_t length;   // 集合包含的元素数量       
  int8_t contents[]; // 保存元素的数组
} intset;
```

<img :src="$withBase('/middleware/redislearn/redis整数集合.png')" alt="foo">

**注** 虽然  `contents` 定义了 int8_t 类型 但是实际上 是由 `encoding` 编码方式决定的

## 升级

> 虽然   整数集合 `(intset)`  可以保存类型为int16_t、int32_t或者int64_t的整数值
>
> 每当我们要将一个新元素添加到整数集合里面,并且新元素的类型比整数集合现有所有元素的类型都要长时,整数集合需要先进行升级

### 升级的过程

1. 根据新元素的类型,扩展整数集合底层数组的空间大小,并为新元素分配空间。
2. 将底层数组现有的所有元素都转换成与新元素相同的类型,并将类型转换后的元素放置到正确的位上,而且在放置元素的过程中,需要继续维持底层数组的有序性质不变。
3. 将新元素添加到底层数组里面
4. 修改 整数集合的 `encoding属性`  和 `length属性`



### 升级的好处

- 提升整数集合的灵活性：我们可以通过升级来 自适应添加的新元素 ，而不必担心类型错误
- 节约内存：为了兼容3中类型的值，最保险的情况是 直接分配所有的元素都是最大类型就好了，但会造成空间浪费，而 升级操作只会在有需要的时候进行, 这可以尽量节省内存。

## 降级

> 降级？ 降级是不可能的。 整数集合不支持降级操作,一旦对数组进行了升级,编码就会一直保持升级后的状态。

